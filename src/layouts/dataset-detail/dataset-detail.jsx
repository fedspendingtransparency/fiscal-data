import React, { useEffect, useState } from 'react';
import PageHelmet from '../../components/page-helmet/page-helmet';
import DDNav from '../../components/dataset-detail-nav/dataset-detail-nav';
import Masthead from '../../components/masthead/masthead';
import DatasetAbout from '../../components/dataset-about/dataset-about';
import DatasetData from '../../components/dataset-data/dataset-data';
import ApiQuickGuide from '../../components/api-quick-guide/api-quick-guide';
import RelatedDatasets from '../../components/related-datasets/related-datasets';
import { graphql } from 'gatsby';
import SiteLayout from '../../components/siteLayout/siteLayout';
import LocationAware from '../../components/location-aware/location-aware';
import { useMetadataUpdater } from '../../helpers/metadata/use-metadata-updater-hook';
import DatasetIntroduction from '../../components/dataset-introduction/dataset-introduction';

export const query = graphql`
  query relatedDatasets($relatedDatasets: [String]) {
    allDatasets(filter: { datasetId: { in: $relatedDatasets } }) {
      datasets: nodes {
        datasetId
        slug
        name
        apis {
          apiId
        }
        tagLine
        relatedTopics
        techSpecs {
          earliestDate
          latestDate
          updateFrequency
          lastUpdated
          fileFormat
        }
        dictionary
      }
    }
  }
`;

const DatasetDetail = ({ data, pageContext, location, test }) => {
  const [pageConfig, setPageConfig] = useState(pageContext.config);
  const [finalDatesNotFound, setFinalDatesNotFound] = useState(true);
  const [selectedTable, setSelectedTable] = useState({});
  const updatedPageConfig = useMetadataUpdater(pageContext);
  const updatedDatasetData = useMetadataUpdater(data.allDatasets.datasets);

  const canonical = `/datasets${pageContext.config.slug}`;

  useEffect(() => {
    setPageConfig(updatedPageConfig.config);
    setFinalDatesNotFound(false);
  }, [updatedPageConfig]);

  return (
    <SiteLayout isPreProd={pageContext.isPreProd}>
      <PageHelmet
        datasetDetails={pageContext?.config}
        pageTitle={pageContext?.seoConfig?.pageTitle || ''}
        description={pageContext?.seoConfig?.description || ''}
        keywords={pageContext?.seoConfig?.keywords || ''}
        canonical={canonical}
      />
      <Masthead title={pageContext.config.name} bannerCallout={pageContext?.config.bannerCallout} />
      <DDNav />
      <div className="ddpBodyBackground">
        <DatasetIntroduction
          summaryText={pageContext.config.summaryText}
          techSpecs={pageConfig.techSpecs}
          dictionary={pageContext.config.dictionary}
        />
        <DatasetData
          setSelectedTableProp={setSelectedTable}
          finalDatesNotFound={finalDatesNotFound}
          config={pageConfig}
          location={location}
          publishedReportsProp={pageConfig.publishedReports}
        />
        <DatasetAbout config={pageContext.config} test={test} />
        <ApiQuickGuide selectedTable={selectedTable} config={pageContext.config} />
        <RelatedDatasets datasets={updatedDatasetData} referrer={pageContext.config.name} />
      </div>
    </SiteLayout>
  );
};

export default LocationAware(DatasetDetail);
